#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –¥–∏—Å–∫–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–µ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/cleanup_disk_space.sh [--force]

set -e

REMOTE_HOST="4feb"
REMOTE_DIR="~/strain_ultra_minimal"
FORCE=${1:-""}

echo "üßπ –û–ß–ò–°–¢–ö–ê –î–ò–°–ö–ê –ù–ê –ü–†–û–î–ê–ö–®–ù –°–ï–†–í–ï–†–ï"
echo "üìÖ –î–∞—Ç–∞: $(date '+%Y-%m-%d %H:%M:%S')"
echo "üåê –°–µ—Ä–≤–µ—Ä: $REMOTE_HOST"
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
run_remote() {
    local cmd="$1"
    echo "üîß –í—ã–ø–æ–ª–Ω—è—é: $cmd"
    ssh $REMOTE_HOST "cd $REMOTE_DIR && $cmd"
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É..."
if ! ssh -o ConnectTimeout=5 $REMOTE_HOST "echo '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ'" >/dev/null 2>&1; then
    echo "‚ùå –ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É $REMOTE_HOST"
    exit 1
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏—Å–∫–∞
echo "üìä –¢–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞:"
run_remote "df -h | grep '/dev/vda2'"

echo ""
echo "üîç –ê–Ω–∞–ª–∏–∑ Docker —Ä–µ—Å—É—Ä—Å–æ–≤:"
run_remote "docker system df"

if [ "$FORCE" != "--force" ]; then
    echo ""
    echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ë—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:"
    echo "   1. –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö Docker –æ–±—Ä–∞–∑–æ–≤"
    echo "   2. –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö Docker volumes"
    echo "   3. –û—á–∏—Å—Ç–∫–∞ Docker build cache"
    echo "   4. –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ª–æ–≥–æ–≤"
    echo "   5. –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø–∞–∫–µ—Ç–æ–≤"
    echo ""
    echo "üìã –°–û–•–†–ê–ù–Ø–¢–°–Ø:"
    echo "   ‚úÖ –í—Å–µ —Ä–∞–±–æ—Ç–∞—é—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
    echo "   ‚úÖ –û–±—Ä–∞–∑—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π"
    echo "   ‚úÖ Volumes —Å –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π"
    echo "   ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã"
    echo ""
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/N): " confirm
    if [[ $confirm != [yY] ]]; then
        echo "‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞"
        exit 0
    fi
fi

echo ""
echo "üöÄ –ù–∞—á–∏–Ω–∞—é –æ—á–∏—Å—Ç–∫—É –¥–∏—Å–∫–∞..."

# 1. –£–¥–∞–ª—è–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ Docker –æ–±—Ä–∞–∑—ã
echo ""
echo "1Ô∏è‚É£ –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö Docker –æ–±—Ä–∞–∑–æ–≤..."
run_remote "docker image prune -f"

# 2. –£–¥–∞–ª—è–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ volumes
echo ""
echo "2Ô∏è‚É£ –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö Docker volumes..."
run_remote "docker volume prune -f"

# 3. –û—á–∏—â–∞–µ–º build cache
echo ""
echo "3Ô∏è‚É£ –û—á–∏—Å—Ç–∫–∞ Docker build cache..."
run_remote "docker builder prune -f"

# 4. –û—á–∏—â–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)
echo ""
echo "4Ô∏è‚É£ –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ª–æ–≥–æ–≤..."
run_remote "sudo journalctl --vacuum-time=7d" || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å journalctl (—Ç—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ sudo)"

# 5. –û—á–∏—â–∞–µ–º –∫—ç—à –ø–∞–∫–µ—Ç–æ–≤
echo ""
echo "5Ô∏è‚É£ –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø–∞–∫–µ—Ç–æ–≤..."
run_remote "sudo apt-get clean" || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å apt cache (—Ç—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ sudo)"

# 6. –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
echo ""
echo "6Ô∏è‚É£ –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
run_remote "sudo find /tmp -type f -atime +7 -delete" || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å /tmp (—Ç—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ sudo)"

# 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä—É–ø–Ω—ã–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã
echo ""
echo "7Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä—É–ø–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤..."
echo "üìã –û–±—Ä–∞–∑—ã —Ä–∞–∑–º–µ—Ä–æ–º –±–æ–ª–µ–µ 500MB:"
run_remote "docker images --format 'table {{.Repository}}\t{{.Tag}}\t{{.Size}}' | grep -E '[0-9]+\.[0-9]+GB|[5-9][0-9][0-9]MB|[0-9][0-9][0-9][0-9]MB'"

echo ""
echo "üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏—Å–∫–∞ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏:"
run_remote "df -h | grep '/dev/vda2'"

echo ""
echo "üîç Docker —Ä–µ—Å—É—Ä—Å—ã –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏:"
run_remote "docker system df"

echo ""
echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –¥–∏—Å–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "üí° –î–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –º–æ–∂–Ω–æ:"
echo "   - –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã: docker rmi <image_id>"
echo "   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã: du -sh /* | sort -hr"
echo "   - –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –≤ ~/*/logs/" 