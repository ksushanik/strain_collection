# Правила работы с сервисным слоем хранилища

Документ зафиксирован 28.10.2025 и используется как база для код-ревью задач, затрагивающих данные хранилища. Цель - обеспечить единообразие транзакций, логирования и тестирования.

## 1. Общие принципы

1. **Единая точка входа.** Любые изменения моделей `Storage`, `StorageBox`, `SampleStorageAllocation` и поля `Sample.storage` выполняются только через функции из `storage_management/services.py`.
2. **Транзакции и блокировки.** Новые операции реализуются с помощью `transaction.atomic()` и `select_for_update()` на ключевых строках (ячейка, образец, allocation). В сервисе запрещены «сырые» запросы без блокировок.
3. **Логирование.** Каждый сервис возвращает `ServiceResult` с заполненными `ServiceLogEntry`; вызов API обязан вызвать `log_change` по этим данным. Чистое написание логов во вьюхах без сервисного результата считается ошибкой.
4. **Изоляция API.** DRF-вью не выполняют прямых операций с ORM (кроме чтения/агрегаций). При появлении новой ручки сначала добавляется сервис, затем тонкая обвязка во вью.

## 2. Требования к новым сервисам

- Валидация аргументов выполняется в сервисе, внешние слои получают `StorageServiceError` с понятным `message`, `code` и `extra`.
- Вся создаваемая бизнес-логика сопровождается модульными тестами (юнит или API), а конкурентные сценарии покрываются с использованием `TransactionTestCase` и синхронизационных примитивов (см. `StorageServiceConcurrencyTests`).
- При изменении нескольких сущностей используйте `generate_batch_id()` и прокидывайте `batch_id` в логи для упрощения аудита.

## 3. Чек-лист для код-ревью

1. **Вызов сервиса**: изменения проходят через функцию в `storage_management/services.py`, а не напрямую через ORM во вью/командах.
2. **Транзакция и блокировки**: во всех критичных запросах есть `transaction.atomic()` и `select_for_update()`.
3. **Логи**: сервис возвращает `ServiceResult.logs`, а слой API вызывает `log_change` с этими записями.
4. **Ошибки**: используются только `StorageServiceError`; HTTP-слой не создаёт кастомных ответов “в обход” сервиса.
5. **Тесты**: есть покрытие API/юнит-тестами и, при необходимости, конкурентными тестами. Новые сценарии добавляются в уже существующие классы (`StorageAPITests`, `StorageServiceConcurrencyTests`).

## 4. Как добавлять новые операции

1. Спроектировать функцию в сервисном слое и покрыть её тестами.
2. Заменить вызовы во вью или management-командах на новую функцию.
3. Обновить OpenAPI (через `extend_schema`) и документацию / релевантные планы.
4. Провести код-ревью по чек-листу выше и убедиться, что все тесты проходят локально и в CI.

Соблюдение этих правил обязательно для всех изменений, влияющих на данные хранилища.
