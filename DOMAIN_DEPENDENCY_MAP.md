# Карта зависимостей между доменами

## Анализ текущей архитектуры

### Выявленные домены

На основе анализа моделей Django выделены следующие домены:

#### 1. **Справочники (Reference Data)**
- `IndexLetter` - индексные буквы
- `Location` - местоположения
- `Source` - источники образцов
- `Comment` - комментарии
- `AppendixNote` - примечания
- `IUKColor` - цвета окраски ИУК
- `AmylaseVariant` - варианты амилазы
- `GrowthMedium` - среды роста

**Характеристики:**
- Низкая частота изменений
- Используются как справочники
- Независимы друг от друга
- Могут быть вынесены в отдельный сервис

#### 2. **Управление штаммами (Strain Management)**
- `Strain` - основная сущность штаммов

**Характеристики:**
- Центральная сущность системы
- Связана с образцами (1:N)
- Независима от других доменов
- Кандидат на отдельный микросервис

#### 3. **Управление образцами (Sample Management)**
- `Sample` - образцы штаммов
- `SampleGrowthMedia` - связь образцов со средами роста
- `SamplePhoto` - фотографии образцов

**Характеристики:**
- Тесно связан с штаммами
- Использует справочники
- Связан с хранилищем
- Сложный для выделения из-за множественных связей

#### 4. **Управление хранилищем (Storage Management)**
- `Storage` - информация о хранении (бокс + ячейка)
- `StorageBox` - контейнеры для хранения

**Характеристики:**
- Физическое представление хранения
- Связан с образцами
- Может быть независимым сервисом

#### 5. **Аудит и логирование (Audit & Logging)**
- `ChangeLog` - журнал изменений

**Характеристики:**
- Кросс-доменная функциональность
- Может быть общим сервисом

## Матрица зависимостей

| Домен | Справочники | Штаммы | Образцы | Хранилище | Аудит |
|-------|-------------|--------|---------|-----------|-------|
| **Справочники** | - | ❌ | ⬅️ | ❌ | ⬅️ |
| **Штаммы** | ❌ | - | ⬅️ | ❌ | ⬅️ |
| **Образцы** | ➡️ | ➡️ | - | ➡️ | ⬅️ |
| **Хранилище** | ❌ | ❌ | ⬅️ | - | ⬅️ |
| **Аудит** | ➡️ | ➡️ | ➡️ | ➡️ | - |

**Легенда:**
- ➡️ - использует (зависит от)
- ⬅️ - используется (предоставляет данные)
- ❌ - нет прямой зависимости

## Детальный анализ связей

### Образцы → Справочники
```python
# Sample модель использует:
index_letter = ForeignKey(IndexLetter)
source = ForeignKey(Source)
location = ForeignKey(Location)
iuk_color = ForeignKey(IUKColor)
amylase_variant = ForeignKey(AmylaseVariant)
```

### Образцы → Штаммы
```python
strain = ForeignKey(Strain)  # Один штамм - много образцов
```

### Образцы → Хранилище
```python
storage = ForeignKey(Storage)  # Место хранения образца
```

### Образцы → Среды роста (M2M)
```python
# Через промежуточную модель SampleGrowthMedia
sample = ForeignKey(Sample)
growth_medium = ForeignKey(GrowthMedium)
```

### Фотографии → Образцы
```python
sample = ForeignKey(Sample)  # Фото привязаны к образцам
```

## Рекомендации по разделению

### Этап 1: Подготовка (текущий)
1. **Создать четкие границы доменов в коде**
   - Разделить API endpoints по доменам
   - Создать отдельные сервисные слои
   - Выделить domain-specific логику

### Этап 2: Слабая связанность
1. **Справочники** - первый кандидат на выделение
   - Минимальные зависимости
   - Стабильные данные
   - Простая миграция

2. **Хранилище** - второй кандидат
   - Четко определенная ответственность
   - Ограниченные связи

### Этап 3: Сложные домены
1. **Штаммы и Образцы** - требуют осторожного подхода
   - Тесная связь (1:N)
   - Возможно, стоит оставить в одном сервисе
   - Или использовать event-driven подход

## Технические долги

### Смешанная архитектура
- **Проблема**: Pydantic + DRF в одном API
- **Решение**: Постепенный переход на DRF serializers

### Монолитная структура
- **Проблема**: Все домены в одном Django приложении
- **Решение**: Разделение на Django apps по доменам

### Отсутствие событийной архитектуры
- **Проблема**: Прямые связи между доменами
- **Решение**: Введение событий для межсервисного взаимодействия

## План миграции

### Фаза 1: Реструктуризация монолита
1. Создать отдельные Django apps:
   - `reference_data`
   - `strain_management`
   - `sample_management`
   - `storage_management`
   - `audit_logging`

2. Перенести модели и API в соответствующие apps

### Фаза 2: Выделение сервисов
1. **Справочники** → отдельный сервис
2. **Хранилище** → отдельный сервис
3. **Аудит** → общий сервис для всех

### Фаза 3: Основные домены
1. Решить судьбу связки **Штаммы-Образцы**
2. Внедрить событийную архитектуру
3. Настроить межсервисное взаимодействие

## Риски и митигация

### Высокий риск
- **Миграция данных** между сервисами
- **Производительность** при межсервисных вызовах
- **Консистентность данных** в распределенной системе

### Средний риск
- **Сложность развертывания** множественных сервисов
- **Отладка** распределенных транзакций

### Митигация
- Поэтапная миграция с возможностью отката
- Тщательное тестирование на каждом этапе
- Мониторинг производительности
- Использование паттернов Saga для распределенных транзакций